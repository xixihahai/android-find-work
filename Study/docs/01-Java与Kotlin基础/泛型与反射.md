# 泛型与反射

## 1. 概述

泛型和反射是 Java 语言的两个重要特性。泛型提供了编译时类型安全检查，反射则允许程序在运行时检查和操作类的结构。本文将深入讲解泛型的类型擦除机制、通配符使用，以及反射的原理和性能优化。

## 2. 核心原理

### 2.1 泛型基础

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          泛型基础                                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  泛型的作用:                                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  1. 类型安全: 编译时检查类型，避免 ClassCastException           │   │
│  │  2. 消除强制类型转换: 编译器自动插入类型转换代码                 │   │
│  │  3. 代码复用: 一套代码支持多种类型                              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  泛型的使用方式:                                                        │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  1. 泛型类:    class Box<T> { T value; }                        │   │
│  │  2. 泛型接口:  interface List<E> { void add(E e); }             │   │
│  │  3. 泛型方法:  <T> T getValue(T t) { return t; }                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  类型参数命名约定:                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  E - Element (集合元素)                                         │   │
│  │  K - Key (键)                                                   │   │
│  │  V - Value (值)                                                 │   │
│  │  T - Type (类型)                                                │   │
│  │  N - Number (数字)                                              │   │
│  │  S, U, V - 第二、三、四个类型                                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 类型擦除

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          类型擦除 (Type Erasure)                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  什么是类型擦除:                                                        │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  Java 泛型是伪泛型，只在编译期有效                              │   │
│  │  编译后，泛型信息会被擦除，替换为原始类型 (Raw Type)            │   │
│  │  这是为了兼容 JDK 5 之前的代码                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  擦除规则:                                                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  泛型类型              │  擦除后                                │   │
│  │  ─────────────────────────────────────────────────────────────  │   │
│  │  List<String>          │  List                                  │   │
│  │  List<T>               │  List                                  │   │
│  │  T                     │  Object                                │   │
│  │  T extends Comparable  │  Comparable                            │   │
│  │  T extends A & B       │  A (第一个边界)                        │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  擦除示例:                                                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  // 编译前                                                      │   │
│  │  public class Box<T> {                                          │   │
│  │      private T value;                                           │   │
│  │      public T getValue() { return value; }                      │   │
│  │      public void setValue(T value) { this.value = value; }      │   │
│  │  }                                                              │   │
│  │                                                                 │   │
│  │  // 编译后 (类型擦除)                                           │   │
│  │  public class Box {                                             │   │
│  │      private Object value;                                      │   │
│  │      public Object getValue() { return value; }                 │   │
│  │      public void setValue(Object value) { this.value = value; } │   │
│  │  }                                                              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  类型擦除的影响:                                                        │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  1. 不能使用基本类型作为类型参数: List<int> ❌                  │   │
│  │  2. 不能创建泛型数组: new T[10] ❌                              │   │
│  │  3. 不能使用 instanceof 检查泛型类型: obj instanceof List<String> ❌│ │
│  │  4. 不能创建泛型类的实例: new T() ❌                            │   │
│  │  5. 静态成员不能使用类的泛型参数                                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.3 通配符

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          通配符 (Wildcards)                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  三种通配符:                                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  1. 无界通配符: <?>                                             │   │
│  │  2. 上界通配符: <? extends T>  (协变)                           │   │
│  │  3. 下界通配符: <? super T>    (逆变)                           │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  类型继承关系:                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                        Object                                   │   │
│  │                           ↑                                     │   │
│  │                        Number                                   │   │
│  │                       ↗      ↖                                  │   │
│  │                  Integer    Double                              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  上界通配符 <? extends Number>:                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  - 可以接受 Number 及其子类                                     │   │
│  │  - 只能读取 (生产者)，不能写入                                  │   │
│  │                                                                 │   │
│  │  List<? extends Number> list;                                   │   │
│  │  Number n = list.get(0);  // ✓ 可以读取为 Number               │   │
│  │  list.add(1);             // ✗ 编译错误，不能写入               │   │
│  │                                                                 │   │
│  │  原因: 编译器不知道具体类型，可能是 List<Integer> 或 List<Double>│   │
│  │        如果允许写入，可能导致类型不匹配                         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  下界通配符 <? super Integer>:                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  - 可以接受 Integer 及其父类                                    │   │
│  │  - 只能写入 (消费者)，读取只能是 Object                         │   │
│  │                                                                 │   │
│  │  List<? super Integer> list;                                    │   │
│  │  list.add(1);             // ✓ 可以写入 Integer                │   │
│  │  Object o = list.get(0);  // ✓ 只能读取为 Object               │   │
│  │  Integer i = list.get(0); // ✗ 编译错误                        │   │
│  │                                                                 │   │
│  │  原因: 编译器不知道具体类型，可能是 List<Integer>、List<Number>  │   │
│  │        或 List<Object>，只能确定可以写入 Integer                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  PECS 原则 (Producer Extends, Consumer Super):                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  - 如果只读取数据 (生产者)，使用 <? extends T>                  │   │
│  │  - 如果只写入数据 (消费者)，使用 <? super T>                    │   │
│  │  - 如果既读又写，不使用通配符                                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.4 反射机制

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          反射机制                                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  什么是反射:                                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  反射是 Java 提供的一种机制，允许程序在运行时:                   │   │
│  │  - 获取类的信息 (类名、方法、字段、注解等)                      │   │
│  │  - 创建对象实例                                                 │   │
│  │  - 调用方法                                                     │   │
│  │  - 访问和修改字段                                               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  获取 Class 对象的方式:                                                 │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  1. Class.forName("com.example.MyClass")  // 动态加载           │   │
│  │  2. MyClass.class                         // 类字面量           │   │
│  │  3. obj.getClass()                        // 对象实例           │   │
│  │  4. ClassLoader.loadClass("...")          // 类加载器           │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  反射 API:                                                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  Class<T>                                                       │   │
│  │  ├── getName()              // 获取类名                         │   │
│  │  ├── getConstructors()      // 获取公共构造函数                 │   │
│  │  ├── getDeclaredConstructors() // 获取所有构造函数              │   │
│  │  ├── getMethods()           // 获取公共方法 (包括继承的)        │   │
│  │  ├── getDeclaredMethods()   // 获取本类声明的所有方法           │   │
│  │  ├── getFields()            // 获取公共字段                     │   │
│  │  ├── getDeclaredFields()    // 获取所有字段                     │   │
│  │  ├── getAnnotations()       // 获取注解                         │   │
│  │  └── newInstance()          // 创建实例 (已废弃)                │   │
│  │                                                                 │   │
│  │  Method                                                         │   │
│  │  ├── invoke(obj, args...)   // 调用方法                         │   │
│  │  ├── setAccessible(true)    // 设置可访问 (突破 private)        │   │
│  │  └── getParameterTypes()    // 获取参数类型                     │   │
│  │                                                                 │   │
│  │  Field                                                          │   │
│  │  ├── get(obj)               // 获取字段值                       │   │
│  │  ├── set(obj, value)        // 设置字段值                       │   │
│  │  └── setAccessible(true)    // 设置可访问                       │   │
│  │                                                                 │   │
│  │  Constructor                                                    │   │
│  │  └── newInstance(args...)   // 创建实例                         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.5 注解与 APT

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          注解与 APT                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  注解的分类:                                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  按保留策略 (RetentionPolicy):                                  │   │
│  │  - SOURCE:  只在源码中保留，编译时丢弃                          │   │
│  │  - CLASS:   保留到字节码，运行时不可见 (默认)                   │   │
│  │  - RUNTIME: 运行时可见，可通过反射获取                          │   │
│  │                                                                 │   │
│  │  按作用目标 (ElementType):                                      │   │
│  │  - TYPE:           类、接口、枚举                               │   │
│  │  - FIELD:          字段                                         │   │
│  │  - METHOD:         方法                                         │   │
│  │  - PARAMETER:      参数                                         │   │
│  │  - CONSTRUCTOR:    构造函数                                     │   │
│  │  - LOCAL_VARIABLE: 局部变量                                     │   │
│  │  - ANNOTATION_TYPE: 注解                                        │   │
│  │  - PACKAGE:        包                                           │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  APT (Annotation Processing Tool):                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  编译时注解处理器，在编译期间处理注解，生成代码                  │   │
│  │                                                                 │   │
│  │  工作流程:                                                      │   │
│  │  1. 编译器扫描源码中的注解                                      │   │
│  │  2. 调用注册的注解处理器                                        │   │
│  │  3. 处理器生成新的 Java 文件                                    │   │
│  │  4. 编译器编译生成的文件                                        │   │
│  │  5. 重复直到没有新文件生成                                      │   │
│  │                                                                 │   │
│  │  常见应用:                                                      │   │
│  │  - ButterKnife: 视图绑定                                        │   │
│  │  - Dagger/Hilt: 依赖注入                                        │   │
│  │  - Room: 数据库 ORM                                             │   │
│  │  - EventBus: 事件总线                                           │   │
│  │  - Retrofit: 网络请求                                           │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 3. 关键源码解析

### 3.1 泛型类型擦除示例
